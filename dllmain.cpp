// dllmain.cpp : Definiert den Einstiegspunkt f√ºr die DLL-Anwendung.
#include <Windows.h>
#include <thread>

#include "altV-SDK/ICore.h"
#include "memory.h"

static HMODULE this_module = nullptr;

LPVOID WINAPI initialize(LPVOID a1)
{

    AllocConsole();
    freopen_s((FILE**)stdout, "CONOUT$", "w", stdout);

    alt::ICore* altv_core_instance_ptr = *(alt::ICore**)g_memory.fix_mov(g_memory.find_pattern("altv-client.dll", "48 89 0D ?? ?? ?? ?? 48 8D 3D ?? ?? ?? ??"));

    std::cout << std::hex << altv_core_instance_ptr << std::endl;

    alt::ICore::SetInstance(altv_core_instance_ptr);

    std::cout << std::hex << &alt::ICore::Instance() << std::endl;
    
    std::cout << alt::ICore::Instance().GetCamPos() << std::endl;

    while (true)
    {
        std::this_thread::sleep_for(std::chrono::milliseconds(10));
        if (GetAsyncKeyState(VK_END) & 1)
        {
            fclose(stdout);
            FreeConsole();
            FreeLibraryAndExitThread(this_module, 0);
        }
    }
}

BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)
{

    if (ul_reason_for_call == DLL_PROCESS_ATTACH)
    {
        this_module = hModule;
        auto handle = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)initialize, 0, 0, 0);
        if (!handle)
            return TRUE;
        CloseHandle(handle);
    }
    return TRUE;
}
